#!/usr/bin/env bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=`cd $(dirname $0); cd ..; pwd`

cd $BUILD_DIR

INSTALLED_CHROME_PATH=$BUILD_DIR/.chrome-for-testing/chrome-linux64/chrome
echo Chrome installed?
file $INSTALLED_CHROME_PATH

# Use playwright install --dry-run to figure out where Playwright will expect chrome to be
export PLAYWRIGHT_BROWSERS_PATH="$BUILD_DIR/.playwright-browsers"
yarn run playwright install --dry-run chromium
EXPECTED_CHROMIUM_BASE=$(yarn run playwright install --dry-run chromium | grep 'chromium-[0-9]' | awk '/Install location/ {print $3}')
EXPECTED_CHROMIUM_DIR=$EXPECTED_CHROMIUM_BASE/chrome-linux

echo BUILD_DIR: $BUILD_DIR
echo EXPECTED_CHROMIUM_DIR: $EXPECTED_CHROMIUM_DIR
echo INSTALLED_CHROME_PATH: $INSTALLED_CHROME_PATH

mkdir -p $EXPECTED_CHROMIUM_DIR
ln -s $INSTALLED_CHROME_PATH $EXPECTED_CHROMIUM_DIR/chrome

# CHROMIUM_PATH=$(pnpm playwright install --dry-run chromium | awk '/Install location/ {print $3}'); mkdir -p \"$CHROMIUM_PATH/chrome-linux\"; ln -s $PLAYWRIGHT_BROWSERS_PATH/chrome-linux64/chrome $CHROMIUM_PATH/chrome-linux/chrome"
