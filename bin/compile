#!/usr/bin/env bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=`cd $(dirname $0); cd ..; pwd`

cd $BUILD_DIR

export PLAYWRIGHT_BROWSERS_PATH="$BUILD_DIR/.playwright-browsers"

yarn run playwright install --dry-run chromium
CHROMIUM_PATH=$(yarn run playwright install --dry-run chromium | grep 'chromium-[0-9]' | awk '/Install location/ {print $3}')

echo BUILD_DIR: $BUILD_DIR
echo CHROMIUM_PATH: $CHROMIUM_PATH
echo PLAYWRIGHT_BROWSERS_PATH: $PLAYWRIGHT_BROWSERS_PATH

REAL_CHROME_BINARY=$CHROMIUM_PATH/chrome-linux64/chrome

echo Binary at $CREAL_CHROME_BINARY ?
file $REAL_CHROME_BINARY

mkdir -p \"$PLAYWRIGHT_BROWSERS_PATH/chrome-linux\"

EXPECTED_CHROME_BINARY=$PLAYWRIGHT_BROWSERS_PATH/chrome-linux/chrome

ln -s $REAL_CHROME_BINARY $EXPECTED_CHROME_BINARY

# CHROMIUM_PATH=$(pnpm playwright install --dry-run chromium | awk '/Install location/ {print $3}'); mkdir -p \"$CHROMIUM_PATH/chrome-linux\"; ln -s $PLAYWRIGHT_BROWSERS_PATH/chrome-linux64/chrome $CHROMIUM_PATH/chrome-linux/chrome"
